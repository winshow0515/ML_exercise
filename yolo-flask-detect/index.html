<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            font-size: 12px;
            max-width: 90%;
            word-wrap: break-word;
        }

        #debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            font-size: 10px;
            max-width: 90%;
            color: #ff0;
        }

        #toggleBtn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 15px 30px;
            font-size: 16px;
            font-family: monospace;
            font-weight: bold;
            background: #0f0;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        #toggleBtn.paused {
            background: #f00;
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="info">Initializing...</div>
        <div id="debug"></div>
        <button id="toggleBtn" onclick="toggleDetection()">PAUSE</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        const debug = document.getElementById('debug');
        const toggleBtn = document.getElementById('toggleBtn');
        
        let isProcessing = false;
        let isRunning = true;  // Detection on/off state
        let detectionCount = 0;

        // Debug log
        function log(msg) {
            console.log(msg);
            debug.textContent = msg;
        }

        // Toggle detection on/off
        function toggleDetection() {
            isRunning = !isRunning;
            
            if (isRunning) {
                toggleBtn.textContent = 'PAUSE';
                toggleBtn.classList.remove('paused');
                info.textContent = 'Detection RUNNING';
            } else {
                toggleBtn.textContent = 'START';
                toggleBtn.classList.add('paused');
                info.textContent = 'Detection PAUSED';
                // Keep the last detection on screen when paused
            }
        }

        log(`Protocol: ${window.location.protocol}`);
        log('Requesting camera access...');
        
        navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        })
        .then(stream => {
            log('Camera access granted!');
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                info.textContent = 'Ready - Detection RUNNING';
                log(`Video size: ${video.videoWidth}x${video.videoHeight}`);
                startDetection();
            };
        })
        .catch(err => {
            const errorMsg = `Camera error: ${err.name} - ${err.message}`;
            info.textContent = errorMsg;
            log(errorMsg);
            
            if (err.name === 'NotAllowedError') {
                info.innerHTML = 'Camera permission denied!<br>Please allow camera access and reload.';
            } else if (err.name === 'NotFoundError') {
                info.innerHTML = 'No camera found!';
            } else if (err.name === 'NotSupportedError') {
                info.innerHTML = 'HTTPS required!<br>Use https:// instead of http://';
            }
        });

        function captureAndDetect() {
            // Skip if paused or already processing
            if (!isRunning || isProcessing) return;
            
            isProcessing = true;

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0);

            const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);

            fetch('/detect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
            .then(res => res.json())
            .then(data => {
                if (data.detections && isRunning) {  // Only draw if still running
                    drawDetections(data.detections);
                    detectionCount++;
                    info.textContent = `Detections: ${detectionCount} | Objects: ${data.detections.length}`;
                }
            })
            .catch(err => {
                info.textContent = 'Server error: ' + err.message;
            })
            .finally(() => {
                isProcessing = false;
            });
        }

        function drawDetections(detections) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const scaleX = canvas.width / video.videoWidth;
            const scaleY = canvas.height / video.videoHeight;

            detections.forEach(det => {
                const [x1, y1, x2, y2] = det.bbox;
                
                const x = x1 * scaleX;
                const y = y1 * scaleY;
                const w = (x2 - x1) * scaleX;
                const h = (y2 - y1) * scaleY;

                ctx.strokeStyle = '#0f0';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, w, h);

                const label = `${det.class} ${(det.confidence * 100).toFixed(0)}%`;
                ctx.fillStyle = '#0f0';
                ctx.font = '14px monospace';
                ctx.fillText(label, x, y - 5);
            });
        }

        function startDetection() {
            setInterval(captureAndDetect, 500);
        }
    </script>
</body>
</html>